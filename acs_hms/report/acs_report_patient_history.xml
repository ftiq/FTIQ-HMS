<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="acs_report_patient_history_template">
        <t t-call="web.external_layout">
            <div class="page">
                <div class="oe_structure"/>
                <div class="row mb-1 text-center">
                        <h3>
                            <strong>
                                <span>Patient Medical History: </span>
                                <span t-field="doc.patient_id.code"/>
                            </strong>
                        </h3>
                </div>

                <div class="row mb-3 border-bottom pb-2">
                    <t t-set="data" t-value="doc.acs_patient_history_report()"/>
                    <div class="d-flex justify-content-between">
                        <div>
                            <t t-if="data">
                                <strong>Report Period:</strong>
                                <span t-esc="data['date_from']"/> to <span t-esc="data['date_to']"/>
                            </t>    
                        </div>
                        <div>
                            <strong>Generated On:</strong>
                            <span t-esc="datetime.datetime.now().strftime('%d-%m-%Y')"/>
                        </div>
                    </div>
                </div>

                <h5 class="mb-2"><b>Patient Profile</b></h5>

                <t t-call="acs_hms_base.patient_information_template">
                    <t t-set="patient" t-value="doc.patient_id"/>
                </t>

                <table class="table table-bordered align-middle">
                    <tr>
                        <td><b>Primary Doctor</b></td>
                        <td><span t-field="doc.patient_id.primary_physician_id"/></td>
                        <t t-if="doc.acs_patient_history_report().get('appointments') and data['appointments']">
                            <td><b>Last Visit</b></td>
                            <td>
                                <span t-esc="max(data['appointments'].mapped('date')).strftime('%d-%m-%Y')"/>
                            </td>
                        </t>
                        <t t-else=""/>
                    </tr>
                </table>

                <t t-if="data">
                    <h5 class="mb-2"><b>Medical Overview</b></h5>
                    <table class="table table-bordered">
                        <tr>
                            <td><b>Total Visits</b></td>
                            <td>
                                Consultation: 
                                <span t-esc="len(data['appointments'].filtered(lambda a: a.consultation_type == 'consultation'))"/> |
                                Follow-up: 
                                <span t-esc="len(data['appointments'].filtered(lambda a: a.consultation_type == 'followup'))"/>
                            </td>
                        </tr>
                        <t t-if="doc.patient_id.medical_alert_ids">
                            <tr>
                                <td><b>Medical Alerts</b></td>
                                <td><span t-esc="', '.join(doc.patient_id.medical_alert_ids.mapped('name'))"/></td>
                            </tr>
                        </t>
                        <t t-if="doc.patient_id.allergy_ids">
                            <tr>
                                <td><b>Known Allergies</b></td>
                                <td><span t-esc="', '.join(doc.patient_id.allergy_ids.mapped('name'))"/></td>
                            </tr>
                        </t>
                        <t t-if="doc.patient_id.patient_diseases_ids">
                            <tr>
                                <td><b>Chronic Conditions</b></td>
                                <td>
                                    <t t-set="chronic_diseases" t-value="doc.patient_id.patient_diseases_ids.filtered(lambda d: d.status == 'chronic').mapped('disease_ids.name')"/>
                                    <span t-esc="', '.join(chronic_diseases)"/>
                                </td>
                            </tr>
                        </t>

                        <t t-if="data['appointments'].diseases_ids">
                            <tr>
                                <td><b>Major Diagnoses</b></td>
                                <td>
                                    <t t-foreach="data['appointments']" t-as="line">
                                        <span t-field="line.diseases_ids"/>
                                    </t>
                                </td>
                            </tr>
                        </t>
                        <t t-if="data['appointments'].prescription_ids">
                            <tr>
                                <td><b>Last Medications</b></td>
                                <td>
                                    <t t-set="pres_lines" 
                                    t-value="data['appointments'].prescription_ids and 
                                            data['appointments'].prescription_ids.sorted(key=lambda p: p.appointment_id.date, reverse=True)[0]
                                            .prescription_line_ids or []"/>
                                    <span t-esc="', '.join([l.product_id.display_name for l in pres_lines])"/>
                                </td>
                            </tr>
                        </t>
                    </table>
                </t>

                <div name="diagnoses">
                    <t t-if="doc.patient_id.patient_diseases_ids.disease_ids and data['appointments']">
                        <h5 class="mb-2"><b>Diagnoses</b></h5>
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>ICD Code</th>
                                    <th>Condition</th>
                                    <th>Diagnosis Date</th>
                                    <th>Physician</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="sorted(doc.patient_id.patient_diseases_ids, key=lambda d: d.diagnosed_date or '', reverse=True)" t-as="lines">
                                    <t t-foreach="lines.disease_ids" t-as="line">
                                        <tr>
                                            <td><span t-field="line.code"/> <t t-if="line.classification">(<span t-field="line.classification"/>)</t></td>
                                            <td><span t-field="line.name"/></td>
                                            <td><span t-esc="lines.diagnosed_date.strftime('%d-%m-%Y')"/></td>
                                            <td><span t-esc="lines.physician_id.name"/></td>
                                            <td><span t-field="lines.status"/></td>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </div>

                <div name="detailed_visit_history">
                    <t t-if="data['appointments']">
                        <h5 class="mb-2"><b>Detailed Visit History</b></h5>
                        <t t-foreach="data['appointments'].sorted(key=lambda r: r.date or fields.Date.today(), reverse=True)[:5]" t-as="line">
                            <div class="p-1 mb-1">
                                <b>Visit Date:</b> <span t-esc="line.date.strftime('%d-%m-%Y') if line.date else ''"/><br/>
                                <t t-if="line.department_id">
                                    <b>Department:</b> <span t-field="line.department_id"/><br/>
                                </t>
                                <b>Doctor:</b> <span t-field="line.physician_id"/><br/>
                                <t t-if="line.chief_complain">
                                    <b>Chief Complaint:</b> <span t-field="line.chief_complain"/><br/>
                                </t>
                                <t t-if="line.differential_diagnosis">
                                    <b>Diagnosis:</b> <span t-field="line.differential_diagnosis"/><br/>
                                </t>
                                <t t-if="line.prescription_ids.prescription_line_ids">
                                    <b>Medications:</b> 
                                        <span t-esc="', '.join(['%s x %s days' % (p.product_id.display_name, p.days) for p in line.prescription_ids.prescription_line_ids])"/>
                                    <br/>
                                </t>
                                <t t-if="line.notes">
                                    <b>Key Results:</b> <span t-field="line.notes"/><br/>
                                </t>
                            </div>
                        </t>
                    </t>
                </div>

                <div name="vitals_key_lab_trend">
                    <t t-if="doc.patient_id.evaluation_ids and data['appointments']">
                        <h5 class="mb-2"><b>Vitals Trends</b></h5>
                        <table class="table table-bordered text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>BP</th>
                                    <th>Pulse</th>
                                    <th>Temp</th>
                                    <th>Weight</th>
                                    <th>BMI</th>
                                    <th>RBS</th>
                                </tr>
                            </thead>
                            <tbody class="text-start">
                                <t t-foreach="doc.patient_id.evaluation_ids" t-as="line">
                                    <tr>
                                        <td><span t-esc="line.date.strftime('%d-%m-%Y') if line.date else ''"/></td>
                                        <td><span t-field="line.systolic_bp"/>/<span t-field="line.diastolic_bp"/></td>
                                        <td><span t-field="line.hr"/></td>
                                        <td><span t-field="line.temp"/><span t-field="line.acs_temp_name"/></td>
                                        <td><span t-field="line.weight"/><span t-field="line.acs_weight_name"/></td>
                                        <td><span t-esc="'%.2f' % line.bmi"/></td>
                                        <td><span t-field="line.rbs"/><span t-field="line.acs_rbs_name"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </div>

                <div name="past_family_history">
                    <t t-if="doc.patient_id.family_history_ids or doc.patient_id.genetic_risks_ids">
                        <h5 class="mb-2"><b>Past &amp; Family History</b></h5>
                        <table class="table table-bordered">
                            <t t-if="doc.patient_id.family_history_ids">
                                <tr>
                                    <td><b>Family History</b></td>
                                    <td>
                                        <span t-esc="', '.join(['%s : %s' % (p.relative, p.diseases_ids.mapped('name')) for p in doc.patient_id.family_history_ids])"/>
                                    </td>
                                </tr>
                            </t>
                            <t t-if="doc.patient_id.genetic_risks_ids">
                                <tr>
                                    <td><b>Genetic Risk</b></td>
                                    <td>
                                        <span t-esc="', '.join([p.disease_gene.display_name for p in doc.patient_id.genetic_risks_ids])"/>
                                    </td>
                                </tr>
                            </t>
                        </table>
                    </t>
                </div>

                <div class="mt-4">
                    <p class="fst-italic">This summary is for medical reference purposes only. Not valid
                    for legal use unless signed and stamped by the issuing hospital.</p>

                    <p><strong>Doctor's Signature:</strong></p>
                    <img t-att-src="'data:image/png;base64,%s' % (doc.patient_id.primary_physician_id.acs_signature.decode())" class="img-fluid" style="max-height:60px;"/>
                </div>
            </div>
        </t>
    </template>

    <template id="acs_report_patient_history">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="acs_hms.acs_report_patient_history_template"/>
            </t>
        </t>
    </template>

    <record id="acs_action_report_patient_history" model="ir.actions.report">
        <field name="name">Patient History Report</field>
        <field name="model">acs.patient.history.report.wiz</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">acs_hms.acs_report_patient_history</field>
        <field name="report_file">acs_hms.acs_report_patient_history</field>
        <field name="binding_model_id" ref="model_acs_patient_history_report_wiz"/>
        <field name="binding_type">report</field> 
    </record>

</odoo>