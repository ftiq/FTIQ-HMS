<odoo>
    <template id="acs_report_patient_history_surgery" inherit_id="acs_hms.acs_report_patient_history_template">
        <xpath expr="//t[@t-if='data']/table/t[4]" position="after">
            <t t-set="surgeries" t-value="doc.acs_patient_history_report().get('surgeries')"/>
            <t t-if="surgeries">
                <tr>
                    <td><b>Surgeries</b></td>
                    <td>
                        <span t-esc="', '.join(surgeries.mapped('surgery_name'))"/>
                    </td>
                </tr>
            </t>
        </xpath>

        <xpath expr="//div[@name='detailed_visit_history']" position="after">
            <div class="mt-3">
                <t t-if="surgeries">
                    <h5 class="mb-2"><b>Surgeries</b></h5>
                    <table class="table table-bordered table-sm align-middle text-center" style="page-break-inside: avoid; table-layout: fixed;">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Surgery Name</th>
                                <th>Surgeon</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody class="text-start">
                            <t t-foreach="surgeries" t-as="line">
                                <tr>
                                    <td><span t-esc="line.start_date.strftime('%d-%m-%Y') if line.start_date else ''"/></td>
                                    <td><span t-field="line.surgery_name"/></td>
                                    <td><span t-field="line.primary_physician_id"/></td>
                                    <td><span t-field="line.adv_on_dis"/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
            </div>
        </xpath>

        <xpath expr="//div[@name='past_family_history']/t/table/t" position="before">
            <t t-if="surgeries and surgeries.patient_id.past_surgeries_ids">
                <tr>
                    <td><b>Past Surgeries</b></td>
                    <td>
                        <span t-esc="', '.join(surgeries.patient_id.past_surgeries_ids.mapped('description'))"/>
                    </td>
                </tr>
            </t>
        </xpath>

        <xpath expr="//div[@name='past_family_history']" position="after">
            <t t-if="surgeries and (not surgeries.patient_id.family_history_ids and not surgeries.patient_id.genetic_risks_ids) and surgeries.patient_id.past_surgeries_ids">
                <div name="past_surgeries_history">
                    <h5 class="mb-2"><b>Past &amp; Family History</b></h5>
                    <table class="table table-bordered">
                        <tr>
                            <td><b>Past Surgeries</b></td>
                            <td>
                                <span t-esc="', '.join(surgeries.patient_id.past_surgeries_ids.mapped('description'))"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </t>
        </xpath>
    </template>
</odoo>